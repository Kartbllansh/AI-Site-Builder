@echo off
:: =============================================
:: Скрипт для сборки React/Vite проекта
:: Создаёт папку dist с относительными путями к JS/CSS/картинкам
:: Предназначен для новичков, которые сгенерировали сайт через AI
:: =============================================

:: --- 1. Проверка Node.js ---
node -v >nul 2>&1
IF ERRORLEVEL 1 (
    echo [Ошибка] Node.js не установлен.
    echo 1) Перейдите на https://nodejs.org/
    echo 2) Скачайте LTS версию и установите.
    echo 3) После установки снова запустите этот скрипт.
    pause
    exit /b
)

:: --- 2. Проверка npm ---
npm -v >nul 2>&1
IF ERRORLEVEL 1 (
    echo [Ошибка] npm не найден.
    echo Важно понимать:
    echo npm — это инструмент, который всегда устанавливается вместе с Node.js.
    echo Если npm не найден, значит Node.js был установлен неправильно или PATH настроен некорректно.
    echo Решение:
    echo 1) Переустановите Node.js с официального сайта.
    echo 2) Закройте и снова откройте скрипт после установки.
    pause
    exit /b
)

:: --- 3. Исправление vite.config.ts на относительные пути ---
IF EXIST "vite.config.ts" (
    echo --- Проверяем vite.config.ts на базовый путь ---
    powershell -Command "(gc vite.config.ts) -replace 'base:.*','base: \"./\"' | Set-Content vite.config.ts"
    echo Установлен base='./' для корректной работы ссылок на JS/CSS/картинки.
)

:: --- 4. Установка зависимостей ---
echo --- Устанавливаем зависимости ---
npm install
IF ERRORLEVEL 1 (
    echo [Ошибка] Не удалось установить зависимости.
    echo Возможные причины:
    echo 1) Нет интернета.
    echo 2) Нет прав на папку проекта.
    echo Попробуйте снова.
    pause
    exit /b
)

:: --- 5. Сборка проекта ---
echo --- Собираем проект ---
npm run build
IF ERRORLEVEL 1 (
    echo [Ошибка] Сборка проекта завершилась с ошибкой.
    echo Возможные причины:
    echo 1) Ошибки в коде приложения.
    echo 2) Проблемы в vite.config.ts.
    echo 3) Несовместимые пакеты.
    echo Не переживайте — внимательно прочитайте ошибки выше и попробуйте исправить их.
    pause
    exit /b
)

:: --- 6. Проверка папки dist ---
IF NOT EXIST "dist" (
    echo [Ошибка] Папка dist не создана.
    echo Проверьте логи сборки выше.
    pause
    exit /b
)

echo --- ✅ Сборка завершена успешно! ---
echo Папка dist готова к загрузке на сервер.
echo dist/
echo   ├── index.html
echo   └── assets/
echo       ├── *.js
echo       └── *.css
pause
exit /b
